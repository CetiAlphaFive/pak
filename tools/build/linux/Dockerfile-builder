
ARG R_MAJOR=4.1

FROM ghcr.io/r-hub/r-minimal/r-minimal:${R_MAJOR} as build

WORKDIR /root

# system requirements -----------------------------------------------------

RUN apk add linux-headers bash gcc musl-dev g++ pkgconf

# zlib --------------------------------------------------------------------

RUN wget https://www.zlib.net/zlib-1.2.11.tar.gz
RUN tar xzf zlib-*.tar.gz
RUN cd zlib-* &&                                    \
    CFLAGS=-fPIC ./configure --static &&            \
    make &&                                         \
    make install

# openssl -----------------------------------------------------------------

RUN wget https://www.openssl.org/source/openssl-1.1.1d.tar.gz
RUN tar xzf openssl-*.tar.gz
RUN apk add perl linux-headers
RUN cd openssl-* &&                                 \
    ./config no-shared &&                           \
    make &&                                         \
    make install &&                                 \
    rm -rf /usr/local/bin/openssl                   \
       /usr/local/share/{man/doc}

# libnghttp2 --------------------------------------------------------------

RUN wget https://github.com/nghttp2/nghttp2/releases/download/v1.40.0/nghttp2-1.40.0.tar.gz
RUN tar xzf nghttp2-*.tar.gz
RUN cd nghttp2-* &&                                 \
    ./configure --enable-static --disable-shared && \
    make &&                                         \
    make install &&                                 \
    rm -rf /usr/local/share/{man/doc}

# libcurl now -------------------------------------------------------------

RUN wget https://curl.haxx.se/download/curl-7.68.0.tar.gz
RUN tar xzf curl-*.tar.gz
RUN apk add pkgconfig
RUN cd curl-* && \
    ./configure --enable-static --disable-shared   \
        --with-nghttp2=/usr/local/ &&              \
    make &&                                        \
    make install &&                                \
    rm -rf /usr/local/bin/curl                     \
       /usr/local/share/{man/doc}

# =========================================================================

FROM ghcr.io/r-hub/r-minimal/r-minimal:${R_MAJOR}

COPY --from=build /usr/local /usr/local

WORKDIR /root

# -------------------------------------------------------------------------
# set up static compilation
# -------------------------------------------------------------------------

RUN mkdir -p /root/.R
COPY tools/build/linux/Makevars-builder /root/.R/Makevars

# -------------------------------------------------------------------------
# Need a proper cp command for older R versions
# -------------------------------------------------------------------------

RUN apk add --no-cache coreutils findutils
